<%- include('../partials/header') %>
  <div class="container">
  <section class="section project-detail-wrap">
    <a href="/projetos" class="back-link">← Voltar aos projetos</a>
    <h1><%= project.title %></h1>
    <div class="project-meta-row">
      <span><strong>Categoria:</strong> <%= project.category %></span>
      <span><strong>Orçamento:</strong> R$ <%= Number(project.budget).toLocaleString('pt-BR') %></span>
      <span><strong>Status:</strong> <%= project.status === 'open' ? 'Aberto' : project.status === 'in_progress' ? 'Em andamento' : project.status === 'completed' ? 'Concluído' : 'Cancelado' %></span>
      <span>Publicado por <strong><%= project.client_name %></strong></span>
    </div>
    <% if (isOwner && (project.status === 'open' || project.status === 'in_progress')) { %>
    <div class="project-owner-actions">
      <% if (project.status === 'open') { %><a href="/projetos/<%= project.id %>/editar" class="btn btn-ghost">Editar projeto</a><% } %>
      <% if (project.status === 'in_progress') { %>
      <form action="/projetos/<%= project.id %>/concluir" method="post" style="display:inline">
        <button type="submit" class="btn btn-primary">Concluir projeto</button>
      </form>
      <% } %>
      <form action="/projetos/<%= project.id %>/cancelar" method="post" style="display:inline">
        <button type="submit" class="btn btn-ghost">Cancelar projeto</button>
      </form>
    </div>
    <% } %>
    <div class="project-description"><%= project.description %></div>

    <% if (canPropose && user) { %>
    <div class="proposal-box">
      <h2>Enviar proposta</h2>
      <form action="/projetos/<%= project.id %>/proposta" method="post" class="form">
        <label>Carta de apresentação
          <textarea name="cover_letter" required rows="4" placeholder="Apresente-se e explique por que você é a melhor escolha."></textarea>
        </label>
        <label>Valor (R$)
          <input type="number" name="amount" step="0.01" required placeholder="0.00">
        </label>
        <label>Prazo (dias)
          <input type="number" name="delivery_time" required min="1" placeholder="Ex: 7">
        </label>
        <button type="submit" class="btn btn-primary">Enviar proposta</button>
      </form>
    </div>
    <% } %>

    <div class="proposals-section">
      <h2>Propostas (<%= proposals.length %>)</h2>
      <% if (proposals && proposals.length) { %>
      <% proposals.forEach(function(pr) { %>
      <div class="proposal-item">
        <strong><%= pr.freelancer_name %></strong> — R$ <%= Number(pr.amount).toLocaleString('pt-BR') %> — <%= pr.delivery_time %> dias — <%= pr.status === 'pending' ? 'Pendente' : pr.status === 'accepted' ? 'Aceita' : 'Rejeitada' %>
        <div class="cover"><%= pr.cover_letter %></div>
        <% if (isOwner && project.status === 'open' && pr.status === 'pending') { %>
        <div class="proposal-actions">
          <form action="/projetos/<%= project.id %>/proposta/<%= pr.id %>/aceitar" method="post" style="display:inline">
            <button type="submit" class="btn btn-primary btn-sm">Aceitar</button>
          </form>
          <form action="/projetos/<%= project.id %>/proposta/<%= pr.id %>/rejeitar" method="post" style="display:inline">
            <button type="submit" class="btn btn-ghost btn-sm">Rejeitar</button>
          </form>
        </div>
        <% } %>
      </div>
      <% }); %>
      <% } else { %>
      <p>Nenhuma proposta ainda.</p>
      <% } %>
    </div>

    <% if (canChat && (isOwner || project.freelancer_id)) { %>
    <div class="messages-section" id="mensagens">
      <h2>Mensagens</h2>
      <% if (messages && messages.length) { %>
      <ul class="messages-list">
        <% messages.forEach(function(m) { %>
        <li class="message-item <%= m.sender_id === user.id ? 'own' : '' %>">
          <strong><%= m.sender_name %></strong> <small><%= new Date(m.created_at).toLocaleString('pt-BR') %></small>
          <p><%= m.body %></p>
        </li>
        <% }); %>
      </ul>
      <% } else { %><p>Nenhuma mensagem ainda.</p><% } %>
      <form action="/projetos/<%= project.id %>/mensagem" method="post" class="form form-inline">
        <textarea name="body" required rows="2" placeholder="Digite sua mensagem..." maxlength="5000"></textarea>
        <button type="submit" class="btn btn-primary">Enviar</button>
      </form>
    </div>
    <% } %>

    <% if (isOwner && project.status === 'completed' && project.freelancer_id) { %>
    <div class="review-section">
      <h2>Avaliar freelancer</h2>
      <form action="/projetos/<%= project.id %>/avaliar" method="post" class="form">
        <label>Nota (1 a 5 estrelas)
          <select name="rating" required>
            <option value="1">1 ★</option>
            <option value="2">2 ★</option>
            <option value="3">3 ★</option>
            <option value="4">4 ★</option>
            <option value="5" selected>5 ★</option>
          </select>
        </label>
        <label>Comentário (opcional)
          <textarea name="comment" rows="3" placeholder="Conte como foi o trabalho."></textarea>
        </label>
        <button type="submit" class="btn btn-primary">Enviar avaliação</button>
      </form>
    </div>
    <% } %>
  </section>
  </div>
<%- include('../partials/footer') %>
